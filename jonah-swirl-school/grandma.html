<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grandma Recap ¬∑ Jonah</title>
  <link rel="stylesheet" href="./css/base.css?v=jonah-1">
  <link rel="stylesheet" href="./css/weekly.css?v=jonah-1">
  <link rel="stylesheet" href="./css/blooms.css?v=jonah-1">
</head>
<body>
  <main class="wrap">
    <header class="head no-print">
      <a class="btn btn-ghost" href="./index.html">‚Üê Home</a>
      <div class="spacer"></div>
      <a class="btn btn-ghost" href="./day.html">‚úçÔ∏è Day</a>
      <a class="btn btn-ghost" href="./swirlfeed.html">üåÄ Feed</a>
      <a class="btn btn-ghost" href="./weekly.html">üìÖ Weekly</a>
      <a class="btn btn-ghost" href="./grandma-plan.html">üóíÔ∏è Plan Next</a>
      <button id="seedToPlan" class="btn" type="button">‚Üí Seed Next Week Plan</button>
    </header>

    <section class="week-range card" aria-live="polite">
      <h2 id="weekLabel">Week</h2>
      <p class="hint">ISO week (Mon‚ÄìSun). Change in <code>blooms.js</code> if you prefer Sun‚ÄìSat.</p>
    </section>

    <!-- PILLAR COUNTS -->
    <section class="pillars card">
      <h2>By Pillar</h2>
      <div id="pillarBars" class="bars"></div>
    </section>

    <!-- TAG BLOOMS -->
    <section class="blooms card">
      <h2>Blooms (Top Tags)</h2>
      <div id="bloomGrid" class="bloom-grid" aria-live="polite"></div>
      <p class="hint">Size = how often the tag appeared in crumbs this week.</p>
    </section>

    <!-- EXPORT -->
    <section class="export card">
      <h2>Export</h2>
      <div class="export-actions">
        <button id="btnJson" class="btn" type="button">Download JSON</button>
        <button id="btnCsv"  class="btn" type="button">Download CSV</button>
      </div>
      <p class="hint">Exports are read-only snapshots. Your saved crumbs don‚Äôt change.</p>
    </section>
  </main>

  <script type="module" src="./js/storage.js?v=jonah-1"></script>
  <script type="module" src="./js/blooms.js?v=jonah-1"></script>
  <script type="module" src="./js/export.js?v=jonah-1"></script>
  <script type="module">
    import { weekWindow, summarizeWeek, renderPillarBars, renderBlooms, isoLabel } from './js/blooms.js';
    import { downloadJson, downloadCsv } from './js/export.js';
    import { listCrumbs } from './js/storage.js';

    let weekOffset = 0;

    const weekLabel = document.getElementById('weekLabel');
    const bars = document.getElementById('pillarBars');
    const bloomGrid = document.getElementById('bloomGrid');
    const btnJson = document.getElementById('btnJson');
    const btnCsv  = document.getElementById('btnCsv');

    function render(){
      const { start, end } = weekWindow(weekOffset);
      const summary = summarizeWeek(start, end);
      weekLabel.textContent = `Week: ${isoLabel(start)} ‚Äì ${isoLabel(end)}`;
      renderPillarBars(bars, summary.pillars);
      renderBlooms(bloomGrid, summary.tags);
      btnJson.onclick = ()=> downloadJson(summary, start, end);
      btnCsv.onclick  = ()=> downloadCsv(summary, start, end);
    }

    // === Continuity Bridge ‚Üí seed AND promote plan for next week ===
    document.getElementById('seedToPlan')?.addEventListener('click', ()=>{
      const { start, end } = weekWindow(weekOffset);
      const summary = summarizeWeek(start, end);

      // pick the 2 quietest pillars to nudge
      const quiet = Object.entries(summary.pillars)
        .sort((a,b)=>a[1]-b[1]).map(([k])=>k).slice(0,2);

      const SUGGEST = {
        divine: 'Read a verse + 1 sentence prayer',
        family: 'One small home kindness (5 min)',
        self:   'Nature notice: 2 leaves, 1 cloud',
        rrr:    'One page read-aloud or math game',
        work:   'Earn-and-save moment (help + coin jar)'
      };
      const seedCells = {};
      quiet.forEach(p=>{ seedCells[`${p}_Mon`] = SUGGEST[p]; });

      const goals = JSON.parse(localStorage.getItem('swirl_goals_jonah')||'[]')
                      .filter(g=>g.status!=='done');

      const seed = {
        weekStartISO: nextMondayISOFrom(end),
        monthISO: nextMonthISOFrom(end),
        anchor: '',
        cells: seedCells,
        goalsCarry: goals
      };

      // Write seed for grandma-plan flow...
      localStorage.setItem('swirl_plan_seed', JSON.stringify(seed));
      // ...and PROMOTE to active plan so Day page has something to show now
      const activePlan = {
        weekStartISO: seed.weekStartISO,
        monthISO: seed.monthISO,
        anchor: seed.anchor,
        cells: seed.cells
      };
      localStorage.setItem('swirl_plan_jonah', JSON.stringify(activePlan));

      // keep goals store as-is (Day reads it independently)
      location.href = './grandma-plan.html';
    });

    function nextMondayISOFrom(endYmd){
      const d = new Date(endYmd+'T00:00:00Z');
      d.setUTCDate(d.getUTCDate()+1);
      return d.toISOString().slice(0,10);
    }
    function nextMonthISOFrom(endYmd){
      const d = new Date(endYmd+'T00:00:00Z');
      d.setUTCMonth(d.getUTCMonth()+1);
      return d.toISOString().slice(0,7);
    }

    render();
  </script>
</body>
</html>
