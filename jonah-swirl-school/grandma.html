<!doctype html>
<html lang="en">
<head>
Â Â <meta charset="utf-8" />
Â Â <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grandma Recap Â· Jonah</title>
  <link rel="stylesheet" href="./css/base.css?v=jonah-1">
  <link rel="stylesheet" href="./css/weekly.css?v=jonah-1">
  <link rel="stylesheet" href="./css/blooms.css?v=jonah-1">
</head>
<body>
Â Â <main class="wrap">
    <header class="head no-print">
      <a class="btn btn-ghost" href="./index.html">â† Home</a>
      <div class="spacer"></div>
      <a class="btn btn-ghost" href="./day.html">âœï¸ Day</a>
      <a class="btn btn-ghost" href="./swirlfeed.html">ğŸŒ€ Feed</a>
      <a class="btn btn-ghost" href="./weekly.html">ğŸ“… Weekly</a>
      <a class="btn btn-ghost" href="./grandma-plan.html">ğŸ—’ï¸ Plan Next</a>
      <button id="seedToPlan" class="btn" type="button">â†’ Seed Next Week Plan</button>
    </header>

Â Â Â Â <section class="week-range card" aria-live="polite">
Â Â Â Â Â Â <h2 id="weekLabel">Week</h2>
Â Â Â Â Â Â <p class="hint">ISO week (Monâ€“Sun). Change in <code>blooms.js</code> if you prefer Sunâ€“Sat.</p>
Â Â Â Â </section>

Â Â Â Â <!-- PILLAR COUNTS -->
Â Â Â Â <section class="pillars card">
Â Â Â Â Â Â <h2>By Pillar</h2>
Â Â Â Â Â Â <div id="pillarBars" class="bars"></div>
Â Â Â Â </section>

Â Â Â Â <!-- TAG BLOOMS -->
Â Â Â Â <section class="blooms card">
Â Â Â Â Â Â <h2>Blooms (Top Tags)</h2>
Â Â Â Â Â Â <div id="bloomGrid" class="bloom-grid" aria-live="polite"></div>
Â Â Â Â Â Â <p class="hint">Size = how often the tag appeared in crumbs this week.</p>
Â Â Â Â </section>

Â Â Â Â <!-- EXPORT -->
Â Â Â Â <section class="export card">
Â Â Â Â Â Â <h2>Export</h2>
Â Â Â Â Â Â <div class="export-actions">
Â Â Â Â Â Â Â Â <button id="btnJson" class="btn" type="button">Download JSON</button>
Â Â Â Â Â Â Â Â <button id="btnCsv"Â  class="btn" type="button">Download CSV</button>
Â Â Â Â Â Â </div>
Â Â Â Â Â Â <p class="hint">Exports are read-only snapshots. Your saved crumbs donâ€™t change.</p>
Â Â Â Â </section>
Â Â </main>

  <script type="module" src="./js/storage.js?v=jonah-1"></script>
  <script type="module" src="./js/blooms.js?v=jonah-1"></script>
  <script type="module" src="./js/export.js?v=jonah-1"></script>
  <script type="module">
    import { weekWindow, summarizeWeek, renderPillarBars, renderBlooms, isoLabel } from './js/blooms.js';
    import { downloadJson, downloadCsv } from './js/export.js';
    import { listCrumbs, settings } from './js/storage.js';

    let weekOffset = 0;

    const weekLabel = document.getElementById('weekLabel');
    const bars = document.getElementById('pillarBars');
    const bloomGrid = document.getElementById('bloomGrid');
    const btnJson = document.getElementById('btnJson');
    const btnCsv  = document.getElementById('btnCsv');

    function render(){
      const { start, end } = weekWindow(weekOffset);
      const summary = summarizeWeek(start, end);
      weekLabel.textContent = `Week: ${isoLabel(start)} â€“ ${isoLabel(end)}`;
      renderPillarBars(bars, summary.pillars);
      renderBlooms(bloomGrid, summary.tags);
      btnJson.onclick = ()=> downloadJson(summary, start, end);
      btnCsv.onclick  = ()=> downloadCsv(summary, start, end);
    }

    // === Continuity Bridge â†’ seed plan for next week ===
    document.getElementById('seedToPlan')?.addEventListener('click', ()=>{
      const { start, end } = weekWindow(weekOffset);
      const summary = summarizeWeek(start, end);
      const s = settings();

      const quiet = Object.entries(summary.pillars)
        .sort((a,b)=>a[1]-b[1]).map(([k])=>k).slice(0,2);

      const SUGGEST = {
        divine: 'Read a verse + 1 sentence prayer',
        family: 'One small home kindness (5 min)',
        self:   'Nature notice: 2 leaves, 1 cloud',
        rrr:    'One page read-aloud or math game',
        work:   'Earn-and-save moment (help + coin jar)'
      };
      const seedCells = {};
      quiet.forEach(p=>{ seedCells[`${p}_Mon`] = SUGGEST[p]; });

      const seedAnchor = '';

      const goals = JSON.parse(localStorage.getItem('swirl_goals_jonah')||'[]')
                      .filter(g=>g.status!=='done');

      const seed = {
        weekStartISO: nextMondayISOFrom(end),
        monthISO: nextMonthISOFrom(end),
        anchor: seedAnchor,
        cells: seedCells,
        goalsCarry: goals
      };
      localStorage.setItem('swirl_plan_seed', JSON.stringify(seed));

      location.href = './grandma-plan.html';
    });

    function nextMondayISOFrom(endYmd){
      const d = new Date(endYmd+'T00:00:00Z');
      d.setUTCDate(d.getUTCDate()+1);
      return d.toISOString().slice(0,10);
    }
    function nextMonthISOFrom(endYmd){
      const d = new Date(endYmd+'T00:00:00Z');
      d.setUTCMonth(d.getUTCMonth()+1);
      return d.toISOString().slice(0,7);
    }

    render();
  </script>
</body>
</html>
