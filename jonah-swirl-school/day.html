<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drop a Crumb · Jonah</title>
  <link rel="stylesheet" href="./css/base.css?v=jonah-1">
  <link rel="stylesheet" href="./css/day.css?v=jonah-1">
  <link rel="stylesheet" href="./css/settings.css?v=jonah-1">
</head>
<body>
  <!-- DAY VIEW / ENTRY -->
  <!-- QUOTE ROTATOR / VERSE PREVIEW (future) -->

  <main class="day-wrap">
    <header class="day-head">
      <a class="btn btn-ghost" href="./index.html">← Home</a>
      <h1>Drop a Crumb</h1>
    </header>

    <section id="schedule" class="card">
      <h2>Today's Schedule</h2>
      <ul id="scheduleList"></ul>
    </section>

    <form id="crumbForm" class="card">
      <label class="row">
        <span class="lab">Pillar</span>
        <select id="pillar" name="pillar" required>
          <option value="divine">👑 Spiritual Routine</option>
          <option value="family">🏠 Home</option>
          <option value="self">🌱 Self</option>
          <option value="rrr">📚 Skills</option>
          <option value="work">💵 Work</option>
        </select>
      </label>

      <label class="row">
        <span class="lab">What happened?</span>
        <textarea id="text" name="text" rows="3" maxlength="280" placeholder="one line is enough 💛" required></textarea>
      </label>

      <label class="row">
        <span class="lab">Add media</span>
        <input id="photo" type="file" multiple>
      </label>

      <label class="row">
        <span class="lab">Tags</span>
        <input id="tags" name="tags" placeholder="comma, separated" />
      </label>

      <button class="btn" type="submit">Save Crumb</button>
    </form>

    <section id="todayList" class="card">
      <div class="row" style="grid-template-columns: 1fr auto auto;">
        <h2 style="margin:0;">Today</h2>
        <button id="openSettings" class="btn btn-ghost" type="button">⚙︎ Settings</button>
        <button id="parentBtn" class="btn btn-ghost" type="button">Parent Controls</button>
      </div>
      <ul id="todayUl" aria-live="polite"></ul>
    </section>

    <section id="narrative" class="card">
      <h2>Today's Story</h2>
      <p id="narrativeText"></p>
    </section>
  </main>

  <script type="module" src="./js/storage.js?v=jonah-1"></script>
  <script type="module" src="./js/crumb-entry.js?v=jonah-1"></script>
  <script type="module" src="./js/pin.js?v=jonah-1"></script>
  <script type="module" src="./js/photos.js?v=jonah-1"></script>
  <script type="module">
    import { initSync } from './js/sync.js';
    // Start listening to storage events for optional sync.
    initSync();
  </script>
  <script type="module">
    import { todayCrumbs } from './js/storage.js';
    import { renderCommentsFor, mountCommentForm, handleDelete } from './js/comments.js';
    import { seasonClass } from './js/season.js';

    const list = document.getElementById('todayUl');
    const parentBtn = document.getElementById('parentBtn');
    const narrativeText = document.getElementById('narrativeText');
    const scheduleList = document.getElementById('scheduleList');
    const PILL_EMOJI = { divine:'👑', family:'🏠', self:'🌱', rrr:'📚', work:'💵' };

    // Parent controls: set/change PIN
    parentBtn.addEventListener('click', ()=>{
      window.pinPrompt?.({ mode:'set', onOk(){ /* no-op; modal reports success */ } });
    });

    window.addEventListener('swirl:changed', e=>{
      if(e.detail?.type === 'crumb_create' || e.detail?.type === 'crumb_delete'){
        renderList();
      }
    });

    function makeRow(c){
      const li = document.createElement('li');
      li.dataset.id = c.id;
      li.className = 'crumb-age ' + seasonClass(c.tsISO);

      // Row content
      const emoji = PILL_EMOJI[c.pillar] || '•';
      li.innerHTML = `
      <div class="c-top">
        <div class="c-text">${emoji} ${escapeHtml(c.text)}</div>
        <div class="c-actions">
          <button class="btn btn-ghost c-del" type="button" title="Delete">Delete</button>
        </div>
      </div>
      <div class="c-comments-wrap">
        <ul class="c-comments"></ul>
        <form class="c-add"><input placeholder="Add a comment…" maxlength="160"></form>
      </div>
      `;

      // Wire comments
      const commentsUl = li.querySelector('.c-comments');
      const addForm = li.querySelector('.c-add');
      renderCommentsFor(commentsUl, c.id);
      mountCommentForm(addForm, c.id, ()=> renderCommentsFor(commentsUl, c.id));

      // Wire delete (PIN-gated)
      const delBtn = li.querySelector('.c-del');
      handleDelete(delBtn, c.id, renderList);

      return li;
    }

    function renderList(){
      list.innerHTML = '';
      todayCrumbs().forEach(c=> list.appendChild(makeRow(c)));
      renderNarrative();
    }

    function renderNarrative(){
      const crumbs = todayCrumbs();
      narrativeText.textContent = crumbs.map(c=> c.text).join(' ');
    }

    function renderSchedule(){
      scheduleList.innerHTML = '';
      try{
        const plan = JSON.parse(localStorage.getItem('swirl_plan_jonah') || '{}');
        const cells = plan.cells || {};
        const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][new Date().getDay()];
        Object.entries(cells).forEach(([key,val])=>{
          const [pillar, day] = key.split('_');
          if(day===dow && val){
            const li = document.createElement('li');
            li.textContent = `${PILL_EMOJI[pillar]||''} ${val}`;
            scheduleList.appendChild(li);
          }
        });
        const goals = JSON.parse(localStorage.getItem('swirl_goals_jonah') || '[]');
        const todayISO = new Date().toISOString().slice(0,10);
        goals.filter(g=>g.date===todayISO).forEach(g=>{
          const li = document.createElement('li');
          li.textContent = `${PILL_EMOJI[g.pillar]||''} ${g.title}`;
          scheduleList.appendChild(li);
        });
      }catch{}
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

    renderList();
    renderSchedule();
  </script>
  <script type="module" src="./js/settings.js?v=jonah-1"></script>
  <script type="module">
    // Wire settings button
    document.getElementById('openSettings')?.addEventListener('click', ()=> window.openSettings && window.openSettings());
  </script>
</body>
</html>
